<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitcoin Price Prediction</title>
    <style>
        .result-success {
            color: green;
        }
        .result-error {
            color: red;
        }
    </style>
    <!-- 引入 Chart.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Bitcoin Price Prediction</h1>

    <!-- 日期选择控件 -->
    <label for="datePicker">Select a Date: </label>
    <input type="date" id="datePicker" />
    <button id="predictButton">Predict</button>

    <!-- 显示预测结果 -->
    <h2>Prediction Result:</h2>
    <p id="result" class="result-success">Please select a date and click 'Predict' to view the result.</p>
    <p id="actualPrice" class="result-success" style="display: none;">Actual Closing Price: </p>
    <p id="predictionError" class="result-error" style="display: none;">Prediction Error Percentage: </p>

    <!-- 添加一个用于绘制图表的 canvas 元素 -->
    <h2>Prediction vs Actual Closing Price:</h2>
    <canvas id="priceChart" width="400" height="200" style="display: none;"></canvas>

    <script>
        document.getElementById("predictButton").addEventListener("click", function() {
            // 获取用户选择的日期
            const selectedDate = document.getElementById("datePicker").value;

            // 构建 Flask API 请求 URL
            const apiUrl = `http://127.0.0.1:5000/predict?date=${selectedDate}`;

            // 发起请求并处理返回结果
            fetch(apiUrl)
                .then(response => response.json())  // 将返回的 JSON 响应转换为对象
                .then(data => {
                    console.log("API Response:", data);  // 输出返回的 JSON 数据进行调试

                    // 检查 data 中是否存在 predicted_close 和 actual_close 字段
                    if (data.predicted_close !== undefined && data.actual_close !== undefined && data.error_percentage !== undefined) {
                        // 将预测结果显示在页面上
                        document.getElementById("result").textContent = `Predicted Closing Price: ${data.predicted_close}`;
                        
                        // 显示实际收盘价
                        document.getElementById("actualPrice").textContent = `Actual Closing Price: ${data.actual_close}`;
                        document.getElementById("actualPrice").style.display = 'block';

                        // 显示预测误差百分比
                        document.getElementById("predictionError").textContent = `Prediction Error Percentage: ${data.error_percentage}%`;
                        document.getElementById("predictionError").style.display = 'block';

                        // 显示图表并更新数据
                        document.getElementById("priceChart").style.display = 'block';
                        updateChart(data.actual_close, data.predicted_close);
                    } else {
                        // 如果没有实际收盘价或预测收盘价字段，则显示错误信息
                        document.getElementById("result").textContent = `Error: ${data.error || 'Unknown error occurred'}`;
                        document.getElementById("result").classList.remove('result-success');
                        document.getElementById("result").classList.add('result-error');
                        document.getElementById("actualPrice").style.display = 'none';
                        document.getElementById("predictionError").style.display = 'none';
                        document.getElementById("priceChart").style.display = 'none';
                    }
                })
                .catch(error => {
                    // 如果请求失败，显示错误信息
                    document.getElementById("result").textContent = `Error: ${error.message}`;
                    document.getElementById("result").classList.remove('result-success');
                    document.getElementById("result").classList.add('result-error');
                    document.getElementById("actualPrice").style.display = 'none';
                    document.getElementById("predictionError").style.display = 'none';
                    document.getElementById("priceChart").style.display = 'none';
                });
        });

        // 定义图表变量
        let priceChart;

        // 更新图表函数
        function updateChart(actualClose, predictedClose) {
            const ctx = document.getElementById('priceChart').getContext('2d');

            // 如果图表已经存在，先销毁它
            if (priceChart) {
                priceChart.destroy();
            }

            // 创建新的图表
            priceChart = new Chart(ctx, {
                type: 'bar', // 使用条形图展示
                data: {
                    labels: ['Actual Closing Price', 'Predicted Closing Price'],
                    datasets: [{
                        label: 'Price in USD',
                        data: [actualClose, predictedClose],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)', // 实际收盘价的颜色
                            'rgba(255, 99, 132, 0.6)'  // 预测收盘价的颜色
                        ],
                        borderColor: [
                            'rgba(54, 162, 235, 1)', // 实际收盘价边框颜色
                            'rgba(255, 99, 132, 1)'  // 预测收盘价边框颜色
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
